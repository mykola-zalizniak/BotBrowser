<mat-toolbar>
    <span>Installed Kernels</span>
    <span class="spacer"></span>
    <button mat-button (click)="loadAvailableReleases()" [disabled]="loadingReleases">
        <mat-icon>refresh</mat-icon>
        Refresh
    </button>
</mat-toolbar>

@if (error) {
    <div class="error-banner">
        <mat-icon>error</mat-icon>
        {{ error }}
    </div>
}

@for (progress of downloadProgresses; track progress.tagName) {
    @if (progress.status !== 'completed') {
        <div class="download-progress">
            <div class="progress-info">
                <span>
                    {{ progress.status === 'downloading' ? 'Downloading' : 'Extracting' }}
                    {{ progress.tagName }}...
                </span>
                @if (progress.status === 'downloading' && progress.totalBytes > 0) {
                    <span>{{ (progress.downloadedBytes / progress.totalBytes) * 100 | number: '1.0-0' }}%</span>
                }
            </div>
            <mat-progress-bar
                [mode]="progress.status === 'extracting' ? 'indeterminate' : 'determinate'"
                [value]="progress.totalBytes > 0 ? (progress.downloadedBytes / progress.totalBytes) * 100 : 0"
            ></mat-progress-bar>
        </div>
    }
}

<div class="content">
    <!-- Installed Kernels Table -->
    <div class="section">
        <div class="table-container">
            @if (dataSource.data.length === 0) {
                <div class="empty-state">
                    <mat-icon>memory</mat-icon>
                    <p>No kernels installed</p>
                    <p class="hint">Download a kernel from the list below to get started</p>
                </div>
            } @else {
                <table mat-table [dataSource]="dataSource">
                    <ng-container matColumnDef="version">
                        <th mat-header-cell *matHeaderCellDef>Version</th>
                        <td mat-cell *matCellDef="let element">
                            <strong>{{ element.majorVersion }}</strong>
                            <span class="full-version">({{ element.fullVersion }})</span>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="platform">
                        <th mat-header-cell *matHeaderCellDef>Platform</th>
                        <td mat-cell *matCellDef="let element">{{ getPlatformLabel(element.platform) }}</td>
                    </ng-container>

                    <ng-container matColumnDef="installedAt">
                        <th mat-header-cell *matHeaderCellDef>Installed</th>
                        <td mat-cell *matCellDef="let element">{{ formatDate(element.installedAt) }}</td>
                    </ng-container>

                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef></th>
                        <td mat-cell *matCellDef="let element">
                            <button mat-icon-button color="warn" (click)="deleteKernel(element)" matTooltip="Delete">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                </table>
            }
        </div>
    </div>

    <!-- Available Downloads -->
    <div class="section">
        <h3>Available Downloads</h3>
        @if (loadingReleases) {
            <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        }
        <div class="releases-list">
            @for (release of getAvailableForDownload(); track release.tagName) {
                <div class="release-card">
                    <div class="release-info">
                        <span class="major-version">{{ release.majorVersion }}</span>
                        <span class="full-version">{{ release.fullVersion }}</span>
                        <span class="release-date">{{ release.publishedAt | date: 'mediumDate' }}</span>
                    </div>
                    <button
                        mat-stroked-button
                        color="primary"
                        (click)="downloadKernel(release)"
                        [disabled]="isDownloading(release.tagName)"
                    >
                        <mat-icon>{{ isDownloading(release.tagName) ? 'hourglass_empty' : 'download' }}</mat-icon>
                        {{ isDownloading(release.tagName) ? 'Downloading...' : 'Download' }}
                    </button>
                </div>
            }
            @if (getAvailableForDownload().length === 0 && !loadingReleases) {
                <div class="empty-state small">
                    <p>All available kernels are installed</p>
                </div>
            }
        </div>
    </div>
</div>
